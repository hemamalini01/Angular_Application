# Stage 1: Build the Angular application
FROM node:16 as angular-build

WORKDIR /app
COPY src/frontend/package*.json ./
RUN npm install
COPY src/frontend/ .
RUN chmod -R 755 ./node_modules
RUN ./node_modules/.bin/ng build --output-path=./dist/out --base-href=/angular-app/



# Stage 2: Build the Java application
FROM maven:3.8.4-openjdk-17 AS java-build

WORKDIR /app
COPY . /app
RUN mvn clean package -DskipTests



# Stage 3: Setup Tomcat with JDK 17 and deploy applications
FROM openjdk:17-bullseye

# Install Tomcat
RUN apt-get update && \
    apt-get install -y wget && \
    wget https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.59/bin/apache-tomcat-9.0.59.tar.gz -O /tmp/tomcat.tar.gz && \
    tar -xzf /tmp/tomcat.tar.gz -C /opt && \
    ln -s /opt/apache-tomcat-9.0.59 /opt/tomcat && \
    rm /tmp/tomcat.tar.gz && \
    apt-get purge -y --auto-remove wget

ENV CATALINA_HOME /opt/tomcat
ENV PATH $CATALINA_HOME/bin:$PATH
RUN groupadd -r tomcat && \
    useradd -r -g tomcat -d $CATALINA_HOME -s /sbin/nologin tomcat
COPY --from=angular-build /app/dist/out $CATALINA_HOME/webapps/angular-app
COPY --from=java-build /app/target/*.war $CATALINA_HOME/webapps/app.war

RUN chmod 644 $CATALINA_HOME/webapps/app.war
RUN find $CATALINA_HOME/webapps/angular-app -type d -exec chmod 755 {} \; && \
    find $CATALINA_HOME/webapps/angular-app -type f -exec chmod 644 {} \;

RUN chown -R tomcat:tomcat $CATALINA_HOME/webapps && \
    chmod -R 755 $CATALINA_HOME/webapps


# Expose the default Tomcat port
EXPOSE 8080

# ENTRYPOINT ["/entrypoint.sh"]
CMD ["catalina.sh", "run"]
